let initialData = [
    {
        activities: [
            {
                id: 437758,
                parentId: 0,
                orderChild: 0,
                name: 'Capability 1',
                color: '#004c84',
                summary: null,
                heatmaps: [],
                activities: [
                    {
                        id: 437760,
                        parentId: 437758,
                        orderChild: 1,
                        name: 'Capability 1 - Child 2',
                        color: '',
                        summary: null,
                        heatmaps: [],
                        activities: [
                            {
                                id: 437765,
                                parentId: 437760,
                                orderChild: 1,
                                name: 'Capability 1 - Child 2 - Child 3 ',
                                color: '',
                                summary: null,
                                heatmaps: [],
                                activities: [],
                                isParent: false,
                                inputs: [],
                                outputs: [],
                                systems: [],
                                stakeholders: [],
                                customers: [],
                                suppliers: [],
                                levelNumber: '1.1',
                                organizationalGoals: [],
                                opportunities: [],
                                process: [],
                                processCapabilityIds: [],
                                node: 2,
                            },
                            {
                                id: 437766,
                                parentId: 437760,
                                orderChild: 2,
                                name: 'Capability 1 - Child 2 - Child 2',
                                color: '',
                                summary: null,
                                heatmaps: [],
                                activities: [],
                                isParent: false,
                                inputs: [],
                                outputs: [],
                                systems: [],
                                stakeholders: [],
                                customers: [],
                                suppliers: [],
                                levelNumber: '1.2',
                                organizationalGoals: [],
                                opportunities: [],
                                process: [],
                                processCapabilityIds: [],
                                node: 2,
                            },
                            {
                                id: 437767,
                                parentId: 437760,
                                orderChild: 3,
                                name: 'Capability 1 - Child 2 - Child 1',
                                color: '',
                                summary: null,
                                heatmaps: [],
                                activities: [],
                                isParent: false,
                                inputs: [],
                                outputs: [],
                                systems: [],
                                stakeholders: [],
                                customers: [],
                                suppliers: [],
                                levelNumber: '1.3',
                                organizationalGoals: [],
                                opportunities: [],
                                process: [],
                                processCapabilityIds: [],
                                node: 2,
                            },
                            {
                                id: 445455,
                                parentId: 437760,
                                orderChild: 4,
                                name: 'Capability 1 - Child 2 - Child 4',
                                color: '',
                                summary: null,
                                heatmaps: [],
                                activities: [],
                                isParent: false,
                                inputs: [],
                                outputs: [],
                                systems: [],
                                stakeholders: [],
                                customers: [],
                                suppliers: [],
                                levelNumber: '1.4',
                                organizationalGoals: [],
                                opportunities: [],
                                process: [],
                                processCapabilityIds: [],
                                node: 2,
                            },
                        ],
                        isParent: false,
                        inputs: [],
                        outputs: [],
                        systems: [],
                        stakeholders: [],
                        customers: [],
                        suppliers: [],
                        levelNumber: '1',
                        organizationalGoals: [],
                        opportunities: [],
                        process: [],
                        processCapabilityIds: [],
                        node: 1,
                    },
                    {
                        id: 437761,
                        parentId: 437758,
                        orderChild: 2,
                        name: 'Capability 1 - Child 1',
                        color: '',
                        summary: null,
                        heatmaps: [],
                        activities: [
                            {
                                id: 123123123,
                                parentId: 437761,
                                orderChild: 0,
                                name: 'Capability 1 - Child 1 - Child 1',
                                color: '',
                                summary: null,
                                heatmaps: [],
                                activities: [],
                                isParent: false,
                                inputs: [],
                                outputs: [],
                                systems: [],
                                stakeholders: [],
                                customers: [],
                                suppliers: [],
                                levelNumber: '2',
                                organizationalGoals: [],
                                opportunities: [],
                                process: [],
                                processCapabilityIds: [],
                                node: 2,
                            },
                        ],
                        isParent: false,
                        inputs: [],
                        outputs: [],
                        systems: [],
                        stakeholders: [],
                        customers: [],
                        suppliers: [],
                        levelNumber: '2',
                        organizationalGoals: [],
                        opportunities: [],
                        process: [],
                        processCapabilityIds: [],
                        node: 1,
                    },
                ],
                isParent: false,
                inputs: [],
                outputs: [],
                systems: [],
                stakeholders: [],
                customers: [],
                suppliers: [],
                levelNumber: null,
                organizationalGoals: [],
                opportunities: [],
                process: [],
                processCapabilityIds: [],
                node: 0,
            },
            {
                id: 437759,
                parentId: 0,
                orderChild: 0,
                name: 'Capability 2',
                color: '#009a81',
                summary: null,
                heatmaps: [],
                activities: [
                    {
                        id: 437787,
                        parentId: 437759,
                        orderChild: 1,
                        name: 'Capability 2 - Child 2',
                        color: '',
                        summary: null,
                        heatmaps: [],
                        activities: [],
                        isParent: false,
                        inputs: [],
                        outputs: [],
                        systems: [],
                        stakeholders: [],
                        customers: [],
                        suppliers: [],
                        levelNumber: '6',
                        organizationalGoals: [],
                        opportunities: [],
                        process: [],
                        processCapabilityIds: [],
                        node: 1,
                    },
                    {
                        id: 437789,
                        parentId: 437759,
                        orderChild: 3,
                        name: 'Capability 2 - Child 1',
                        color: '',
                        summary: null,
                        heatmaps: [],
                        activities: [
                            {
                                id: 437805,
                                parentId: 437789,
                                orderChild: 4,
                                name: 'Capability 2 - Child 1 - Child 1',
                                color: '',
                                summary: null,
                                heatmaps: [],
                                activities: [],
                                isParent: false,
                                inputs: [],
                                outputs: [],
                                systems: [],
                                stakeholders: [],
                                customers: [],
                                suppliers: [],
                                levelNumber: '8.4',
                                organizationalGoals: [],
                                opportunities: [],
                                process: [],
                                processCapabilityIds: [],
                                node: 2,
                            },
                        ],
                        isParent: false,
                        inputs: [],
                        outputs: [],
                        systems: [],
                        stakeholders: [],
                        customers: [],
                        suppliers: [],
                        levelNumber: '8',
                        organizationalGoals: [],
                        opportunities: [],
                        process: [],
                        processCapabilityIds: [],
                        node: 1,
                    },
                ],
                isParent: false,
                inputs: [],
                outputs: [],
                systems: [],
                stakeholders: [],
                customers: [],
                suppliers: [],
                levelNumber: null,
                organizationalGoals: [],
                opportunities: [],
                process: [],
                processCapabilityIds: [],
                node: 0,
            },
        ],
    },
]

let filterActivities = function (data) {
    return data.map((activity) => {
        let filteredActivity = {
            id: activity.id,
            name: activity.name,
            parentId: activity.parentId,
            node: activity.node,
            activities: activity.activities && activity.activities.length > 0 ? filterActivities(activity.activities) : [],
        }

        return filteredActivity
    })
}

let sortActivities = function (data, criteria) {
    // sort the current level by criteria
    data.sort((a, b) => {
        if (a[criteria] < b[criteria]) {
            return -1
        }
        if (a[criteria] > b[criteria]) {
            return 1
        }
        return 0
    })

    // sort each nested level (if activities array exists and is not empty)
    data.forEach((activity) => {
        if (activity.activities && activity.activities.length > 0) {
            sortActivities(activity.activities, criteria)
        }
    })

    return data
}

let flattenActivities = function (data) {
    let result = []

    for (let activity of data) {
        // Push current activity to result array
        result.push({
            id: activity.id,
            name: activity.name,
            parentId: activity.parentId,
            node: activity.node,
            activities: [], // flatten, so no nested activities
        })

        // If there are nested activities, flatten and push them too
        if (activity.activities && activity.activities.length > 0) {
            result = result.concat(flattenActivities(activity.activities))
        }
    }

    return result
}

// Initialize the DataTable with 'dataWithNodes'
$(function () {
    // Call the function with your data
    let filteredData = filterActivities(initialData[0].activities)

    let sortedData = sortActivities(filteredData, 'name')

    let flattenedData = flattenActivities(sortedData)

    $('#myTable').DataTable({
        data: flattenedData,
        columns: [
            {
                title: 'Name',
                data: 'name',
                render: function (data, type, row) {
                    if (type === 'display') {
                        let color = colors[row.node % colors.length]
                        return '<span style="padding-left:' + row.node * 30 + 'px;">' + data + '</span>'
                    }
                    return data
                },
            },
            {
                title: 'Id',
                data: 'id',
            },
            {
                title: 'Parent Id',
                data: 'parentId',
            },
            {
                title: 'Node',
                data: 'node',
            },
        ],
    })
})
